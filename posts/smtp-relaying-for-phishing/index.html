<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="SMTP Relaying for Phishing" /><meta name="author" content="Babligan" /><meta property="og:locale" content="en_US" /><meta name="description" content="For anyone who’s tried to build phishing infrastucture that’s consistently reliable, you know by now how challenging that can be. First of all, a proper and functioning mail server has many moving parts that have to be perfect for mail to be sent correctly. At the moment, there are many ways to setup a fully functional mailserver but I generally prefer iRedMail. The installation is mostly straight forward (this is a great guide if you aren’t too familiar with the process). Additionally, iRedmail integrates Nginx, Dovecot IMAP server, Postfix SMTP server, OpenLDAP, MySQL/MariaDB or PostgreSQL for storing user information and a bunch of other incredible features." /><meta property="og:description" content="For anyone who’s tried to build phishing infrastucture that’s consistently reliable, you know by now how challenging that can be. First of all, a proper and functioning mail server has many moving parts that have to be perfect for mail to be sent correctly. At the moment, there are many ways to setup a fully functional mailserver but I generally prefer iRedMail. The installation is mostly straight forward (this is a great guide if you aren’t too familiar with the process). Additionally, iRedmail integrates Nginx, Dovecot IMAP server, Postfix SMTP server, OpenLDAP, MySQL/MariaDB or PostgreSQL for storing user information and a bunch of other incredible features." /><link rel="canonical" href="https://sneezy-ladybug.github.io/posts/smtp-relaying-for-phishing/" /><meta property="og:url" content="https://sneezy-ladybug.github.io/posts/smtp-relaying-for-phishing/" /><meta property="og:site_name" content="Sneezy Ladybug" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-31T03:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="SMTP Relaying for Phishing" /><meta name="twitter:site" content="@sneezy_ladybug" /><meta name="twitter:creator" content="@Babligan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Babligan"},"headline":"SMTP Relaying for Phishing","dateModified":"2021-04-15T08:17:31+00:00","datePublished":"2021-03-31T03:00:00+00:00","description":"For anyone who’s tried to build phishing infrastucture that’s consistently reliable, you know by now how challenging that can be. First of all, a proper and functioning mail server has many moving parts that have to be perfect for mail to be sent correctly. At the moment, there are many ways to setup a fully functional mailserver but I generally prefer iRedMail. The installation is mostly straight forward (this is a great guide if you aren’t too familiar with the process). Additionally, iRedmail integrates Nginx, Dovecot IMAP server, Postfix SMTP server, OpenLDAP, MySQL/MariaDB or PostgreSQL for storing user information and a bunch of other incredible features.","url":"https://sneezy-ladybug.github.io/posts/smtp-relaying-for-phishing/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://sneezy-ladybug.github.io/posts/smtp-relaying-for-phishing/"},"@context":"https://schema.org"}</script><title>SMTP Relaying for Phishing | Sneezy Ladybug</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-D8RZPKVWG8"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-D8RZPKVWG8'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/babligan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sneezy Ladybug</a></div><div class="site-subtitle font-italic">Writer. Infosec enthusiast. Interested in Offensive Infrastructure.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/sneezy-ladybug" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/sneezy_ladybug" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>SMTP Relaying for Phishing</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>SMTP Relaying for Phishing</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Babligan </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Mar 31, 2021, 3:00 AM +0000" prep="on" > Mar 31 <i class="unloaded">2021-03-31T03:00:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 15, 2021, 8:17 AM +0000" prefix="Updated " > Apr 15 <i class="unloaded">2021-04-15T08:17:31+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1560 words">8 min</span></div></div><div class="post-content"><p>For anyone who’s tried to build phishing infrastucture that’s consistently reliable, you know by now how challenging that can be. First of all, a proper and functioning mail server has many moving parts that have to be perfect for mail to be sent correctly. At the moment, there are many ways to setup a fully functional mailserver but I generally prefer <a href="https://www.iredmail.org/">iRedMail</a>. The installation is mostly straight forward (<a href="https://www.linuxbabe.com/mail-server/ubuntu-18-04-iredmail-email-server">this</a> is a great guide if you aren’t too familiar with the process). Additionally, iRedmail integrates Nginx, Dovecot IMAP server, Postfix SMTP server, OpenLDAP, MySQL/MariaDB or PostgreSQL for storing user information and a bunch of other incredible features.</p><p>Usually, a mail server requires the following to be ‘functional’:</p><ul><li>Mailing domain name in good reputation (correct categorization, not blacklisted and age).<li>Other than the usual A (or AAAA, if you are using IPv6) and MX records, your DNS records have to be:<ul><li>SPF compliant (if your server uses both IPv4 and IPv6, remember to have an inclusive record otherwise you’ll get a softfail error i.e <code class="language-plaintext highlighter-rouge">v=spf1 mx ip4:IPv4-ADDRESS ip6:IPv6-ADDRESS ~all</code>)<li>DKIM signed<li>Conforms to DMARC<li>Domain has a PTR record which resolves as expected.</ul><li>SSL/TLS certificates that have to be configured for Nginx/Apache, Dovecot and Postfix.<li>Remove postfix email headers.<li>While this isn’t mandatory, configure port 587 as your primary SMTP rather than port 25.</ul><p>Robust phishing infrastructure usually incooporates a phishing originator either running Gophish or PhishingFrenzy and a separate mail server and implementing the use of a SMTP relay that sits in front of the phishing originator. However, some organizations have hardened spam filters that can be incredibly difficult to get around. Even after implementing all the requirements, while they can help, they ultimately may not be enough.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/phishing-infra.png" alt="[phishing-infra.png]" /></p><p>The primary focus of this blog is on the SMTP relay. In essence, an SMTP relay is server that ‘relays’ your email from your own mail server and queues it up for delivery to its final destination. The relay uses the domain name in the email address and DNS to figure out where the email should be sent.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/smtp-relaying.png" alt="[smtp-relaying.png]" /></p><p>You can configure your own SMTP relay or use a third party relay such as Sendmail, SMTP2GO, Sendgrid, Mailjet or Mailgun.</p><h3 id="standalone-smtp-relay-setup">Standalone SMTP Relay Setup</h3><p>A standalone SMTP relay is completely under our control and acts as a redirector between our target and backend server. Before you set up your SMTP relay, ensure that your backend server (the phishing originator) is fully functional using the checklist above.</p><h5 id="prerequisites">Prerequisites</h5><ol><li>Launch a VPS from your provider and make sure it isn’t blacklisted. You can use <a href="https://mxtoolbox.com/blacklists.aspx">mxtoolbox</a> to check whether your domain or IP address is listed against any email blacklists.<li>SSH into your VPS and configure your IPTables/firewall rules to allow inbound and outbound SMTP traffic.<li>Configure the correct DNS settings. Basically, just have 2 A records, the first one has a host entry of <code class="language-plaintext highlighter-rouge">@</code> and the other one is <code class="language-plaintext highlighter-rouge">mail</code> and both have the SMTP relay’s IP address. Although this is optional, you can chooose to have another A record, which has the host entry of <code class="language-plaintext highlighter-rouge">www</code> and has the IP address of your phishing server.</ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/dns-record.png" alt="[dns-record.png]" /></p><p>Don’t forget the PTR record which is set separately according to your VPS providers instructions.</p><p>After that’s setup, we’ll start with installing and configuring postfix. (I’ll use a regular Ubuntu 18.04 server, but make sure you use the right commands for your server).</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> apt-get <span class="nb">install </span>postfix
</pre></table></code></div></div><p>When the dialog pops us, select <em>Internet Site</em> then enter the domain name assigned to this VPS. Let’s say our VPS’s domain name is abc.com, then the system mail name is abc.com</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/postfix1.png" alt="[postfix1.png]" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/postfix2.png" alt="[postfix2.png]" /></p><p>Then we’ll make it act as a redirector by appending this line at the end of Postfix’s configuration file which is usually at <em>/etc/postfix/main.cf</em>.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> postconf <span class="nt">-e</span> <span class="s1">'mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 [BACKEND-SERVER-IP]'</span>
</pre></table></code></div></div><p>Now that your relay is configured, add it as a relay on your backend server using:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>postconf <span class="nt">-e</span> <span class="s1">'relayhost = [RELAY-IP]:25'</span>
</pre></table></code></div></div><p>Then restart Postfix.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>service postfix restart
</pre></table></code></div></div><p>From my experience, I found that even after setting this up and ensuring that emails were being relayed. They still ended up in the spam folder on Gmail and didn’t make it at all through Outlook. Enter third party SMTP relays.</p><h3 id="third-party-smtp-relays---mailjet">Third Party SMTP Relays - Mailjet</h3><p>There is wide range of third party SMTP relays such as SendMail, SMTP2Go, Sendgrid, Mailgun and Mailjet. While all these options have their own advantages, I chose to use Mailjet as:</p><ul><li>There’s no requirement to enter your credit card details when setting up your account<li>It has a free quota of 200 emails per day<li>It’s comparatively a lot easier to setup.</ul><p>Once you’ve setup your account on Mailjet, we have a few things to do in order to fully set up our SMTP relay to relay through Mailjet. These options are under the Quick Setup on your dashboard.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/quicksetup.png" alt="[quicksetup.png]" /></p><ul><li>Setup SMTP<li>Manage sender addresses/domains<li>Setup domain authentication</ul><h4 id="1-managing-sender-addresses">1. Managing Sender Addresses</h4><p>We’ll setup our domains before we get into setting up SMTP for relaying.</p><p>Under the <strong>Sender domains &amp; Addresses</strong> page, you’ll click on <strong>Add Domain</strong>. A new page will load which allows you to add the domain whose traffic you want to relay. In my case it will be <em>abc.com</em>. Ensure that you have complete control over your domain name registrar and in my case it’s Namecheap.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/adddomain.png" alt="[adddomain.png]" /></p><p>Press Continue. The next page requires you to validate your domain. There are 2 options available. If you do choose to host a temporary file ensure it is on the home folder of any user, including root. I prefer the DNS method as it’s easy and resolves really quick.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/validatedomain.png" alt="[validatedomain.png]" /></p><p>On Namecheap, under Advanced DNS on your domain, create a new TXT record, and assign the values of Host and Value as indicated then set TTL to 5 minutes then save. It should look like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/nc1.png" alt="[nc1.png]" /></p><p>Click <strong>Check Now</strong> and once the record has successfully resolves, you’ll get a success message.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/success.png" alt="[success.png]" /></p><h4 id="2-setup-domain-authentication">2. Setup Domain Authentication</h4><p>Next, we have to authenticate our domain by setting up SPF and DKIM keys. By default, SPF status and DKIM status are both in error. Click manage button and follow the instructions to add SPF and DKIM records.</p><h5 id="setting-up-the-spf-record">Setting Up the SPF Record</h5><p>There are two main points to know about the SPF records:</p><ul><li>SPF record is a TXT record; not be confused with the SPF type. (Although the SPF type could be used, it is not recommended in the industry.)<li>There is only one SPF record per domain. If you have more than one SPF DNS record, ISPs will not know which one to use which may cause authentication issues.</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/spf.png" alt="[spf.png]" /></p><h5 id="setting-up-the-dkim-record">Setting up the DKIM record</h5><p>To setup DKIM authentication, you will be creating a new DKIM record. (Unlike SPF records, there are no issues with having multiple DKIM DNS records in your domain.)</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/dkim.png" alt="[dkim.png]" /></p><p>Finally, your records should look like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/final.png" alt="[final.png]" /></p><p>Ensure that you confirm the status of your DKIM and SPF records after you’ve set them up.</p><h4 id="3-setting-up-smtp">3. Setting Up SMTP</h4><p>Mailjet issues you with the SMTP server address and SMTP credential which is a set of an API-Key and a password.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/api.png" alt="[api.png]" /></p><p>Back on our SMTP relay server, we’ll edit the Postfix configuration file to set the value of relayhost and setup security and authentication support for SMTP through the use of SASL.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/postfix/main.cf
</pre></table></code></div></div><p>Then add the following lines to the end of this file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>relayhost <span class="o">=</span> <span class="k">in</span><span class="nt">-v3</span>.mailjet.com:587
smtp_sasl_auth_enable <span class="o">=</span> <span class="nb">yes
</span>smtp_sasl_password_maps <span class="o">=</span> <span class="nb">hash</span>:/etc/postfix/sasl_passwd
smtp_sasl_security_options <span class="o">=</span> noanonymous
smtp_tls_security_level <span class="o">=</span> may
header_size_limit <span class="o">=</span> 4096000
</pre></table></code></div></div><p>Basically:</p><ul><li>The <em>relayhost</em> setting forces the Postfix SMTP to send all remote messages to the specified mail server instead of trying to deliver them directly to their destination.<li>The <em>smtp_sasl_auth_enable</em> setting enables client-side authentication.<li>With the <em>smtp_sasl_password_maps</em> parameter, we configure the Postfix SMTP client to send username and password information to the mail gateway server. The username and password are stored in a table that contains one username/password combination for each mail gateway server. In our case, it will be stored in /etc/postfix/sasl_passwd.<li>The <em>smtp_sasl_security_options</em> disallows anonymous authentication.<li>The <em>smtp_tls_security_level</em> setting ensures that the connection to the remote smtp server may be encrypted. To explitictly enforce the use of TLS, you can use the <em>encrypt</em> value.<li>The <em>header_size_limit</em> defines the maximum amount of memory in bytes for storing a message header. If a header is larger, the excess is discarded. By default the value is 102400.</ul><p>Then save and close the file.</p><p>Then create the /etc/postfix/sasl_passwd file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/postfix/main.cf
</pre></table></code></div></div><p>Add the SMTP relay host and SMTP credentials to this file like below. Replace api-key/username and secret-key with your real Mailjet API key and secret key.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">in</span><span class="nt">-v3</span>.mailjet.com:587 api-key:secret-key
</pre></table></code></div></div><p>Then save and close the file.</p><p>Next, you’ll create the corresponding hash db file with postmap.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>postmap /etc/postfix/sasl<span class="se">\_</span>passwd
</pre></table></code></div></div><p>Now you should have a file /etc/postfix/sasl_passwd.db. Restart Postfix for the changes to take effect.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart postfix
</pre></table></code></div></div><p>By default, sasl_passwd and sasl_passwd.db file can be read by any user on the server. Change the permission to 600 so only root can read and write to these two files.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo chmod </span>0600 /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db
</pre></table></code></div></div><p>At this point, Postfix will send emails via Mailjet directly to inbox on both Gmail and Outlook. Additionally, when you look at the mail headers they’ll reveal that the mail originates from mailjet.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/inbox.png" alt="[inbox.png]" /></p><h4 id="additional-resources">Additional Resources</h4><ul><li><a href="https://www.socketlabs.com/blog/smtp-relay/">https://www.socketlabs.com/blog/smtp-relay/</a><li><a href="https://www.ired.team/offensive-security/red-team-infrastructure/smtp">https://www.ired.team/offensive-security/red-team-infrastructure/smtp</a><li><a href="https://godlikesecurity.com/index.php/2017/12/14/building-resilient-phishing-campaigns/">https://godlikesecurity.com/index.php/2017/12/14/building-resilient-phishing-campaigns/</a><li><a href="https://www.linuxbabe.com/mail-server/postfix-smtp-relay">https://www.linuxbabe.com/mail-server/postfix-smtp-relay</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/infra/'>Infra</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/smtp/" class="post-tag no-text-decoration" >smtp</a> <a href="/tags/phishing/" class="post-tag no-text-decoration" >phishing</a> <a href="/tags/postfix/" class="post-tag no-text-decoration" >postfix</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=SMTP Relaying for Phishing - Sneezy Ladybug&url=https://sneezy-ladybug.github.io/posts/smtp-relaying-for-phishing/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=SMTP Relaying for Phishing - Sneezy Ladybug&u=https://sneezy-ladybug.github.io/posts/smtp-relaying-for-phishing/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=SMTP Relaying for Phishing - Sneezy Ladybug&url=https://sneezy-ladybug.github.io/posts/smtp-relaying-for-phishing/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/passing-the-phish-II/">Passing the Phish II</a><li><a href="/posts/passing-the-phish/">Passing the Phish</a><li><a href="/posts/smtp-relaying-for-phishing/">SMTP Relaying for Phishing</a><li><a href="/posts/primer-on-iptables/">A Comprehensive Primer on IPTables</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/phishing/">phishing</a> <a class="post-tag" href="/tags/evilginx/">evilginx</a> <a class="post-tag" href="/tags/gophish/">gophish</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/iptables/">iptables</a> <a class="post-tag" href="/tags/netfilter/">netfilter</a> <a class="post-tag" href="/tags/postfix/">postfix</a> <a class="post-tag" href="/tags/smtp/">smtp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/passing-the-phish/"><div class="card-body"> <span class="timeago small" > Jun 25 <i class="unloaded">2021-06-25T16:34:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Passing the Phish</h3><div class="text-muted small"><p> At the core of it, phishing involves tricking a user into doing something they shouldn’t do. Also, not all phishing techniques involve tricking a user into clicking a malicious link on an email, en...</p></div></div></a></div><div class="card"> <a href="/posts/passing-the-phish-II/"><div class="card-body"> <span class="timeago small" > Jun 27 <i class="unloaded">2021-06-27T16:34:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Passing the Phish II</h3><div class="text-muted small"><p> At this point, we’ve should have covered the following according to the previous post. Installation of Gophish Setup SendGrid as our SMTP server Installation of Evilginx and setting up a lur...</p></div></div></a></div><div class="card"> <a href="/posts/primer-on-iptables/"><div class="card-body"> <span class="timeago small" > Feb 20 <i class="unloaded">2021-02-20T11:10:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Comprehensive Primer on IPTables</h3><div class="text-muted small"><p> IPTables is essentially the built in command-line tool for managing Netfilter hooks which basically manages firewall rules. IPTables interacts with the netfilter framework to filter through packets...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/primer-on-iptables/" class="btn btn-outline-primary" prompt="Older"><p>A Comprehensive Primer on IPTables</p></a> <a href="/posts/passing-the-phish/" class="btn btn-outline-primary" prompt="Newer"><p>Passing the Phish</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/sneezy_ladybug">Sneezy Ladybug</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."> Some rights reserved. </span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/phishing/">phishing</a> <a class="post-tag" href="/tags/evilginx/">evilginx</a> <a class="post-tag" href="/tags/gophish/">gophish</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/iptables/">iptables</a> <a class="post-tag" href="/tags/netfilter/">netfilter</a> <a class="post-tag" href="/tags/postfix/">postfix</a> <a class="post-tag" href="/tags/smtp/">smtp</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://sneezy-ladybug.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
